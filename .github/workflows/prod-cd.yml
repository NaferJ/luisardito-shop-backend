name: CD - Production (Backend)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: [self-hosted, linux]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check PROD secrets presence
        run: |
          echo "HAS_HOST=$HAS_HOST"
          echo "HAS_USER=$HAS_USER"
          echo "HAS_PORT=$HAS_PORT"
          echo "HAS_KEY=$HAS_KEY"
        env:
          HAS_HOST: ${{ secrets.PROD_SSH_HOST != '' }}
          HAS_USER: ${{ secrets.PROD_SSH_USER != '' }}
          HAS_PORT: ${{ secrets.PROD_SSH_PORT != '' }}
          HAS_KEY: ${{ secrets.PROD_SSH_KEY != '' }}

      - name: Validate PROD SSH inputs
        shell: bash
        run: |
          [ "${{ secrets.PROD_SSH_HOST }}" != "" ] || { echo "PROD_SSH_HOST missing"; exit 1; }
          [ "${{ secrets.PROD_SSH_USER }}" != "" ] || { echo "PROD_SSH_USER missing"; exit 1; }
          [ "${{ secrets.PROD_SSH_PORT }}" != "" ] || { echo "PROD_SSH_PORT missing"; exit 1; }
          [ "${{ secrets.PROD_SSH_KEY }}" != "" ] || { echo "PROD_SSH_KEY missing"; exit 1; }
          echo "All required PROD SSH secrets are present."

      - name: Test PROD SSH connection
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          passphrase: ${{ secrets.PROD_SSH_PASSPHRASE }}
          port: ${{ secrets.PROD_SSH_PORT }}
          script: |
            whoami
            pwd
            echo "SSH OK"

      - name: Validate PROD repo read token
        shell: bash
        run: |
          [ "${{ secrets.PROD_GITHUB_TOKEN }}" != "" ] || { echo "PROD_GITHUB_TOKEN missing (create a PAT with repo read access)"; exit 1; }
          echo "PROD_GITHUB_TOKEN present."

      - name: Ensure production .env file exists
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          passphrase: ${{ secrets.PROD_SSH_PASSPHRASE }}
          port: ${{ secrets.PROD_SSH_PORT }}
          script: |
            set -e
            ENV_PATH="$HOME/.env.backend.production"
            # Create or overwrite .env with production secrets (safe line-by-line to avoid indentation issues)
            rm -f "$ENV_PATH"
            echo "NODE_ENV=production" >> "$ENV_PATH"
            echo "PORT=${{ secrets.PROD_APP_PORT }}" >> "$ENV_PATH"
            echo "DB_HOST=${{ secrets.PROD_DB_HOST }}" >> "$ENV_PATH"
            echo "DB_PORT=${{ secrets.PROD_DB_PORT }}" >> "$ENV_PATH"
            echo "DB_USER=${{ secrets.PROD_DB_USER }}" >> "$ENV_PATH"
            echo "DB_PASSWORD=${{ secrets.PROD_DB_PASS }}" >> "$ENV_PATH"
            echo "DB_NAME=${{ secrets.PROD_DB_NAME }}" >> "$ENV_PATH"
            echo "DB_SSL=${{ secrets.PROD_DB_SSL }}" >> "$ENV_PATH"
            echo "DB_SSL_REJECT_UNAUTHORIZED=${{ secrets.PROD_DB_SSL_REJECT_UNAUTHORIZED }}" >> "$ENV_PATH"
            echo "JWT_SECRET=${{ secrets.PROD_JWT_SECRET }}" >> "$ENV_PATH"
            echo "KICK_CLIENT_ID=${{ secrets.PROD_KICK_CLIENT_ID }}" >> "$ENV_PATH"
            echo "KICK_CLIENT_SECRET=${{ secrets.PROD_KICK_CLIENT_SECRET }}" >> "$ENV_PATH"
            echo "KICK_REDIRECT_URI=${{ secrets.PROD_KICK_REDIRECT_URI }}" >> "$ENV_PATH"
            # Kick API/OAuth hosts (non-PROD-prefixed repo secrets as requested)
            echo "KICK_API_BASE_URL=${{ secrets.KICK_API_BASE_URL }}" >> "$ENV_PATH"
            echo "KICK_OAUTH_AUTHORIZE_URL=${{ secrets.KICK_OAUTH_AUTHORIZE_URL }}" >> "$ENV_PATH"
            echo "KICK_OAUTH_TOKEN_URL=${{ secrets.KICK_OAUTH_TOKEN_URL }}" >> "$ENV_PATH"
            echo "KICK_OAUTH_REVOKE_URL=${{ secrets.KICK_OAUTH_REVOKE_URL }}" >> "$ENV_PATH"
            chmod 600 "$ENV_PATH"
            echo "Wrote $ENV_PATH"
            sed -e 's/=.*/=***/' "$ENV_PATH"
            ls -l "$ENV_PATH"

      - name: Deploy with Docker Compose (production)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          passphrase: ${{ secrets.PROD_SSH_PASSPHRASE }}
          port: ${{ secrets.PROD_SSH_PORT }}
          script: |
            set -e
            APP_DIR="$HOME/apps/luisardito-shop-backend"
            REPO_URL="https://x-access-token:${{ secrets.PROD_GITHUB_TOKEN }}@github.com/NaferJ/luisardito-shop-backend.git"
            if [ -d "$APP_DIR/.git" ]; then
              cd "$APP_DIR"
              git remote set-url origin "$REPO_URL"
              git fetch origin main
              git reset --hard origin/main
            else
              mkdir -p "$HOME/apps"
              cd "$HOME/apps"
              git clone --depth 1 "$REPO_URL"
              cd luisardito-shop-backend
              git checkout main
            fi

            # Remove possible conflicting containers by name to avoid name conflicts
            for c in luisardito-mysql luisardito-backend luisardito-frontend; do
              if docker ps -a --format '{{.Names}}' | grep -q "^${c}$"; then
                docker rm -f "$c"
              fi
            done

            # Bring stack down and up with production overrides
            docker compose -f docker-compose.yml -f docker-compose.prod.yml down
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build

            # Show status
            docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
