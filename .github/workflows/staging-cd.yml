name: CD - Staging (Backend)

on:
  push:
    branches: [ dev ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check secrets presence
        run: |
          echo "HAS_HOST=$HAS_HOST"
          echo "HAS_USER=$HAS_USER"
          echo "HAS_PORT=$HAS_PORT"
          echo "HAS_KEY=$HAS_KEY"
        env:
          HAS_HOST: ${{ secrets.STG_SSH_HOST != '' }}
          HAS_USER: ${{ secrets.STG_SSH_USER != '' }}
          HAS_PORT: ${{ secrets.STG_SSH_PORT != '' }}
          HAS_KEY: ${{ secrets.STG_SSH_KEY != '' }}

      - name: Validate SSH inputs
        shell: bash
        run: |
          [ "${{ secrets.STG_SSH_HOST }}" != "" ] || { echo "STG_SSH_HOST missing"; exit 1; }
          [ "${{ secrets.STG_SSH_USER }}" != "" ] || { echo "STG_SSH_USER missing"; exit 1; }
          [ "${{ secrets.STG_SSH_PORT }}" != "" ] || { echo "STG_SSH_PORT missing"; exit 1; }
          [ "${{ secrets.STG_SSH_KEY }}" != "" ] || { echo "STG_SSH_KEY missing"; exit 1; }
          echo "All required SSH secrets are present."

      - name: Test SSH connection
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.STG_SSH_HOST }}
          username: ${{ secrets.STG_SSH_USER }}
          key: ${{ secrets.STG_SSH_KEY }}
          passphrase: ${{ secrets.STG_SSH_PASSPHRASE }}
          port: ${{ secrets.STG_SSH_PORT }}
          script: |
            whoami
            pwd
            echo "SSH OK"

      - name: Validate STG repo read token
        shell: bash
        run: |
          [ "${{ secrets.STG_GITHUB_TOKEN }}" != "" ] || { echo "STG_GITHUB_TOKEN missing (create a PAT with repo read access)"; exit 1; }
          echo "STG_GITHUB_TOKEN present."

      - name: Ensure staging .env file exists
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.STG_SSH_HOST }}
          username: ${{ secrets.STG_SSH_USER }}
          key: ${{ secrets.STG_SSH_KEY }}
          passphrase: ${{ secrets.STG_SSH_PASSPHRASE }}
          port: ${{ secrets.STG_SSH_PORT }}
          script: |
            set -e
            ENV_PATH="$HOME/.env.backend.staging"
            # Create or overwrite .env with staging secrets (safe line-by-line to avoid indentation issues)
            rm -f "$ENV_PATH"
            echo "NODE_ENV=staging" >> "$ENV_PATH"
            echo "PORT=${{ secrets.STG_APP_PORT }}" >> "$ENV_PATH"
            echo "DB_HOST=${{ secrets.STG_DB_HOST }}" >> "$ENV_PATH"
            echo "DB_PORT=${{ secrets.STG_DB_PORT }}" >> "$ENV_PATH"
            echo "DB_USER=${{ secrets.STG_DB_USER }}" >> "$ENV_PATH"
            echo "DB_PASS=${{ secrets.STG_DB_PASS }}" >> "$ENV_PATH"
            echo "DB_NAME=${{ secrets.STG_DB_NAME }}" >> "$ENV_PATH"
            echo "DB_SSL=${{ secrets.STG_DB_SSL }}" >> "$ENV_PATH"
            echo "DB_SSL_REJECT_UNAUTHORIZED=${{ secrets.STG_DB_SSL_REJECT_UNAUTHORIZED }}" >> "$ENV_PATH"
            echo "JWT_SECRET=${{ secrets.STG_JWT_SECRET }}" >> "$ENV_PATH"
            echo "KICK_CLIENT_ID=${{ secrets.STG_KICK_CLIENT_ID }}" >> "$ENV_PATH"
            echo "KICK_CLIENT_SECRET=${{ secrets.STG_KICK_CLIENT_SECRET }}" >> "$ENV_PATH"
            echo "KICK_REDIRECT_URI=${{ secrets.STG_KICK_REDIRECT_URI }}" >> "$ENV_PATH"
            chmod 600 "$ENV_PATH"
            echo "Wrote $ENV_PATH"
            sed -e 's/=.*/=***/' "$ENV_PATH"
            ls -l "$ENV_PATH"

      - name: Deploy with Docker Compose (staging)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.STG_SSH_HOST }}
          username: ${{ secrets.STG_SSH_USER }}
          key: ${{ secrets.STG_SSH_KEY }}
          passphrase: ${{ secrets.STG_SSH_PASSPHRASE }}
          port: ${{ secrets.STG_SSH_PORT }}
          script: |
            set -e
            APP_DIR="$HOME/apps/luisardito-shop-backend"
            REPO_URL="https://x-access-token:${{ secrets.STG_GITHUB_TOKEN }}@github.com/NaferJ/luisardito-shop-backend.git"
            if [ -d "$APP_DIR/.git" ]; then
              cd "$APP_DIR"
              git remote set-url origin "$REPO_URL"
              git fetch origin dev
              git reset --hard origin/dev
            else
              mkdir -p "$HOME/apps"
              cd "$HOME/apps"
              git clone --depth 1 "$REPO_URL"
              cd luisardito-shop-backend
              git checkout dev
            fi

            # Remove possible conflicting containers by name to avoid name conflicts
            for c in luisardito-mysql luisardito-backend luisardito-frontend; do
              if docker ps -a --format '{{.Names}}' | grep -q "^${c}$"; then
                docker rm -f "$c"
              fi
            done

            # Bring stack down and up with staging overrides
            docker compose -f docker-compose.yml -f docker-compose.stg.yml down
            docker compose -f docker-compose.yml -f docker-compose.stg.yml up -d --build

            # Show status
            docker compose -f docker-compose.yml -f docker-compose.stg.yml ps
