services:
  db:
    # Keep DB port published in development (use 3307 on host to avoid conflict with local MySQL)
    ports:
      - "3307:3306"
    # Add environment variables for easier access
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: luisardito_shop
      MYSQL_USER: app
      MYSQL_PASSWORD: app

  api:
    # Development overrides
    env_file:
      - .env.development
    working_dir: /app
    volumes:
      - ./:/app
      - /app/node_modules
    ports:
      - "3001:3000"
    restart: unless-stopped
    # Development command with hot reload
    command: >
      sh -c "npm install &&
             npx sequelize db:migrate &&
             npx sequelize db:seed:all || true &&
             npm run dev"
    # Environment variables que sobrescriben .env.development para Docker
    environment:
      - NODE_ENV=development
      - CHOKIDAR_USEPOLLING=true
      # Sobrescribir configuraci√≥n de DB para usar nombre del servicio Docker
      - DB_HOST=db
      - DB_PORT=3306
      - DB_USER=app
      - DB_PASSWORD=app
      - DB_NAME=luisardito_shop
      - DB_SSL=false
      - DB_SSL_REJECT_UNAUTHORIZED=false
      # JWT y otras configuraciones
      - JWT_SECRET=bcad3d86a5f78e7f81a6666d397da64296ce657a467f2e43bfdf7eef520dcb3db6c571f9f9499eb5c72da67fa571afe004f13b91a30dd97c35b8f4b9d2e8541c
      - PORT=3000
    depends_on:
      db:
        condition: service_healthy
